<div role="tabpanel" class="tab-pane fade" id="tab-config-identity-provider" role="tabpanel" aria-labelledby="tab-config-identity-provider">
  <div class="card mb-4">
    <div class="card-header d-flex fs-5">
      <button class="btn d-md-none flex-grow-1 text-start" data-bs-target="#collapse-tab-config-identity-provider" data-bs-toggle="collapse" aria-controls="collapse-tab-config-identity-provider">
        {{ lang.admin.iam }}
      </button>
      <span class="d-none d-md-block">{{ lang.admin.iam }}</span>
    </div>
    <div id="collapse-tab-config-identity-provider" class="card-body collapse" data-bs-parent="#admin-content">
      <p class="offset-sm-3 mb-4">{{ lang.admin.iam_description|raw }}</p>
      <div class="row mb-4">
        <label class="control-label col-md-3 text-sm-end" for="iam_realm">{{ lang.admin.iam }}:</label>
        <div class="col-12 col-md-9 col-lg-4">
          <select
            data-style="btn btn-secondary"
            data-id="iam_provider"
            title="{{ lang.admin.iam_provider }}"
            name="iam_provider" id="iam_provider" class="full-width-select form-control" required>
              <option value="keycloak" {% if not iam_settings.authsource or iam_settings.authsource == 'keycloak' %}selected{% endif %}>Keycloak</option>
              <option value="generic-oidc" {% if iam_settings.authsource == 'generic-oidc' %}selected{% endif %}>Generic-OIDC</option>
          </select>
        </div>
      </div>
      <div id="keycloak_settings" class="{% if iam_settings.authsource and iam_settings.authsource != 'keycloak' %}d-none{% endif %}">
        <form class="form-horizontal" autocapitalize="none" data-id="iam_keycloak" autocorrect="off" role="form" method="post">
          <input type="hidden" name="authsource" value="keycloak">
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end" for="iam_keycloak_url">{{ lang.admin.iam_server_url }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <input type="text" class="form-control" id="iam_keycloak_url" name="server_url" value="{{ iam_settings.server_url }}" required>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end" for="iam_keycloak_realm">{{ lang.admin.iam_realm }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <input type="text" class="form-control" id="iam_keycloak_realm" name="realm" value="{{ iam_settings.realm }}" required>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end" for="iam_keycloak_clientid">{{ lang.admin.iam_client_id }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <input type="text" class="form-control" id="iam_keycloak_clientid" name="client_id" value="{{ iam_settings.client_id }}" required>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end" for="iam_keycloak_clientsecret">{{ lang.admin.iam_client_secret }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <div class="reveal-password-input input-group">
                <input type="password" class="password-field form-control" id="iam_keycloak_clientsecret" name="client_secret" value="{{ iam_settings.client_secret }}" required>
                <button class="toggle-password btn btn-secondary" type="button"><i class="bi bi-eye"></i></button>
              </div>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end" for="iam_keycloak_redirecturl">{{ lang.admin.iam_redirect_url }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <input type="text" class="form-control" id="iam_keycloak_redirecturl" name="redirect_url" value="{{ iam_settings.redirect_url }}" required>
            </div>
          </div>
          <div class="row mb-4">
            <label class="control-label col-md-3 text-sm-end" for="iam_keycloak_version">{{ lang.admin.iam_version }}:</label>
            <div class="col-sm-4">
              <input type="text" class="form-control" id="iam_keycloak_version" name="version" value="{{ iam_settings.version }}" required>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end">{{ lang.admin.iam_mapping }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <div class="row px-2 align-items-center">
                <span class="col-5 p-0 pe-2">Attribute</span>
                <span class="col-5 p-0 pe-2">{{ lang.mailbox.template }}</span>
                <div class="col-2 p-0 d-flex">
                  <button class="btn btn-sm d-block d-sm-inline btn-secondary ms-auto iam_rolemap_add_keycloak"><i class="bi bi-plus-lg"></i></button>
                </div>
              </div>
            </div>
          </div>
          <div class="row mb-2" id="iam_keycloak_mapping_list">
            {% for key, role in iam_settings.mappers %}
            <div class="offset-md-3 col-12 col-md-9 col-lg-4 mb-2">
              <div class="row px-2">
                <div class="col-5 p-0 pe-2">
                  <input type="text" class="form-control me-2" name="mappers" value="{{ iam_settings.mappers[key] }}" required>
                </div>
                <div class="col-5 p-0 pe-2">
                  <select data-live-search="true" name="templates" class="form-control" title="{{ lang.mailbox.template }}" required>
                  {% for mbox_template in mbox_templates %}
                    <option{% if mbox_template.template == iam_settings.templates[key] %} selected{% endif %}>
                      {{ mbox_template.template }}
                    </option>
                  {% endfor %}
                  </select>
                </div>
                <div class="col-2 p-0 d-flex">
                  <button class="iam_keycloak_rolemap_del btn btn-sm d-block d-sm-inline btn-secondary ms-auto"><i class="bi bi-x-lg"></i></button>
                </div>
              </div>
            </div>
            {% endfor %}
            {% if not iam_settings.mappers %}
            <div class="offset-md-3 col-12 col-md-9 col-lg-4 mb-2">
              <div class="row px-2">
                <div class="col-5 p-0 pe-2">
                  <input type="text" class="form-control me-2" name="mappers" value="" required>
                </div>
                <div class="col-5 p-0 pe-2">
                  <select data-live-search="true" name="templates" class="form-control" title="{{ lang.mailbox.template }}" required>
                  {% for mbox_template in mbox_templates %}
                    <option>
                      {{ mbox_template.template }}
                    </option>
                  {% endfor %}
                  </select>
                </div>
                <div class="col-2 p-0 d-flex">
                  <button class="iam_keycloak_rolemap_del btn btn-sm d-block d-sm-inline btn-secondary ms-auto"><i class="bi bi-x-lg"></i></button>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
          <div class="row mb-2 mt-4">
            <label class="control-label col-md-3 text-sm-end"></label>
            <div class="col-12 col-md-9">
              <span>{{ lang.admin.iam_extra_permission|raw }}</span>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end">{{ lang.admin.iam_rest_flow }}</label>
            <div class="col-12 col-md-9">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" name="mailpassword_flow" value="1" {% if iam_settings.mailpassword_flow == 1 %}checked{% endif %}>
              </div>
              <p class="text-muted">
                <small>
                  {{ lang.admin.iam_auth_flow_info|raw }}
                </small>
              </p>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end">{{ lang.admin.iam_periodic_full_sync }}</label>
            <div class="col-12 col-md-9">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" name="periodic_sync"  value="1" {% if iam_settings.periodic_sync == 1 %}checked{% endif %}>
              </div>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end">{{ lang.admin.iam_import_users }}</label>
            <div class="col-12 col-md-9">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" name="import_users"  value="1" {% if iam_settings.import_users == 1 %}checked{% endif %}>
              </div>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end">{{ lang.admin.iam_sync_interval }}</label>
            <div class="col-12 col-md-9 col-lg-4">
              <input class="form-control" type="number" min="1" name="sync_interval" style="width: 80px;"  {% if iam_settings.sync_interval %}value="{{ iam_settings.sync_interval }}"{% else %}value="15"{% endif %}>
            </div>
          </div>
          <div class="row mt-4 mb-2">
            <div class="offset-md-3 col-12 col-md-9 d-flex flex-wrap">
              <div class="btn-group mb-2">   
                <button class="btn btn-sm d-block d-sm-inline btn-secondary iam_test_connection iam_test_connection" data-id="iam_keycloak"><i class="bi bi-play"></i> {{ lang.admin.iam_test_connection }}</button>
                <button class="btn btn-sm d-block d-sm-inline btn-success" data-item="identity-provider" data-action="edit_selected" data-id="iam_keycloak" data-api-url='edit/identity-provider' data-api-attr='{}'><i class="bi bi-check-lg"></i> {{ lang.admin.save }}</button>
              </div>
              <button class="btn btn-sm d-block d-sm-inline btn-danger ms-auto mb-2" data-item="identity-provider" data-action="delete_selected" data-id="iam_keycloak" data-api-url='delete/identity-provider'><i class="bi bi-trash"></i> {{ lang.mailbox.remove }}</button>
            </div>
          </div>
        </form>
      </div>
      <div id="generic_oidc_settings" class="{% if not iam_settings.authsource or iam_settings.authsource != 'generic-oidc' %}d-none{% endif %}">
        <form class="form-horizontal" autocapitalize="none" data-id="iam_generic" autocorrect="off" role="form" method="post">
          <input type="hidden" name="authsource" value="generic-oidc">
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end" for="iam_authorize_url">{{ lang.admin.iam_authorize_url }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <input type="text" class="form-control" id="iam_authorize_url" name="authorize_url" value="{{ iam_settings.authorize_url }}" required>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end" for="iam_token_url">{{ lang.admin.iam_token_url }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <input type="text" class="form-control" id="iam_token_url" name="token_url" value="{{ iam_settings.token_url }}" required>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end" for="iam_userinfo_url">{{ lang.admin.iam_userinfo_url }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <input type="text" class="form-control" id="iam_userinfo_url" name="userinfo_url" value="{{ iam_settings.userinfo_url }}" required>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end" for="iam_client_id">{{ lang.admin.iam_client_id }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <input type="text" class="form-control" id="iam_client_id" name="client_id" value="{{ iam_settings.client_id }}" required>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end" for="iam_client_secret">{{ lang.admin.iam_client_secret }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <div class="reveal-password-input input-group">
                <input type="password" class="password-field form-control" id="iam_client_secret" name="client_secret" value="{{ iam_settings.client_secret }}" required>
                <button class="toggle-password btn btn-secondary" type="button"><i class="bi bi-eye"></i></button>
              </div>
            </div>
          </div>
          <div class="row mb-4">
            <label class="control-label col-md-3 text-sm-end" for="iam_redirect_url">{{ lang.admin.iam_redirect_url }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <input type="text" class="form-control" id="iam_redirect_url" name="redirect_url" value="{{ iam_settings.redirect_url }}" required>
            </div>
          </div>
          <div class="row mb-2">
            <label class="control-label col-md-3 text-sm-end">{{ lang.admin.iam_mapping }}:</label>
            <div class="col-12 col-md-9 col-lg-4">
              <div class="row px-2 align-items-center">
                <span class="col-5 p-0 pe-2">Attribute</span>
                <span class="col-5 p-0 pe-2">Template</span>
                <div class="col-2 p-0 d-flex">
                  <button class="btn btn-sm d-block d-sm-inline btn-secondary ms-auto iam_rolemap_add_generic"><i class="bi bi-plus-lg"></i></button>
                </div>
              </div>
            </div>
          </div>
          <div class="row mb-2" id="iam_generic_mapping_list">
            {% for key, role in iam_settings.mappers %}
            <div class="offset-md-3 col-12 col-md-9 col-lg-4 mb-2">
              <div class="row px-2">
                <div class="col-5 p-0 pe-2">
                  <input type="text" class="form-control me-2" name="mappers" value="{{ iam_settings.mappers[key] }}" required>
                </div>
                <div class="col-5 p-0 pe-2">
                  <select data-live-search="true" name="templates" class="form-control" title="{{ lang.mailbox.template }}" required>
                  {% for mbox_template in mbox_templates %}
                    <option{% if mbox_template.template == iam_settings.templates[key] %} selected{% endif %}>
                      {{ mbox_template.template }}
                    </option>
                  {% endfor %}
                  </select>
                </div>
                <div class="col-2 p-0 d-flex">
                  <button class="iam_generic_rolemap_del btn btn-sm d-block d-sm-inline btn-secondary ms-auto"><i class="bi bi-x-lg"></i></button>
                </div>
              </div>
            </div>
            {% endfor %}
            {% if not iam_settings.mappers %}
            <div class="offset-md-3 col-12 col-md-9 col-lg-4 mb-2">
              <div class="row px-2">
                <div class="col-5 p-0 pe-2">
                  <input type="text" class="form-control me-2" name="mappers" value="" required>
                </div>
                <div class="col-5 p-0 pe-2">
                  <select data-live-search="true" name="templates" class="form-control" title="{{ lang.mailbox.template }}" required>
                  {% for mbox_template in mbox_templates %}
                    <option>
                      {{ mbox_template.template }}
                    </option>
                  {% endfor %}
                  </select>
                </div>
                <div class="col-2 p-0 d-flex">
                  <button class="iam_generic_rolemap_del btn btn-sm d-block d-sm-inline btn-secondary ms-auto"><i class="bi bi-x-lg"></i></button>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
          <div class="row mt-4 mb-2">
            <div class="offset-md-3 col-12 col-md-9 d-flex flex-wrap">
              <div class="btn-group mb-2">   
                <button class="btn btn-sm d-block d-sm-inline btn-secondary iam_test_connection" data-id="iam_generic"><i class="bi bi-play"></i> {{ lang.admin.iam_test_connection }}</button>
                <button class="btn btn-sm d-block d-sm-inline btn-success" data-item="identity-provider" data-action="edit_selected" data-id="iam_generic" data-api-url='edit/identity-provider' data-api-attr='{}'><i class="bi bi-check-lg"></i> {{ lang.admin.save }}</button>
              </div>
              <button class="btn btn-sm d-block d-sm-inline btn-danger ms-auto mb-2" data-item="identity-provider" data-action="delete_selected" data-id="iam_generic" data-api-url='delete/identity-provider'><i class="bi bi-trash"></i> {{ lang.mailbox.remove }}</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
